<!DOCTYPE html>
<html lang="en">
    <head>
        <meta chartset="UTF-8">
        <title>Emit Video</title>
        <script src="https://code.jquery.com/jquery-1.11.2.min.js">
        </script>
        <script src="https://cdn.socket.io/socket.io-1.0.0.js"></script>
    </head>
    <body>
            <canvas id="preview" style="display: none"></canvas>
        <video src = "" id="video" 
        style = "width: 680px; height: 320px"
        autoplay = "true"
        ></video>
        
        <div id="logger">

        </div>
        <script>
            var canvas = document.getElementById("preview");
            var context =  canvas.getContext("2d");

            canvas.width = 800;
            canvas.height = 600;
            context.width = canvas.width;
            context.width = canvas.height;
            var video = document.getElementById("video");
            var socket = io();

            function logger(msg){
                $("#logger").text(msg);
            }

            function loadCam(stream){
                video.srcObject = stream;
                logger("Camera connected correctly");
            }

            function loadFail(stream){
                logger("Camara not connected correctly, RETRY");
            }
            //not sending image to canvas
            function viewVideo(video, context){
                context.drawImage(video, 0,0, context.width, context.height);
                socket.emit('stream', canvas.toDataURL('image/webp'));
            }
            $(function(){
                navigator.getUserMedia = (navigator.getUserMedia || 
                navigator.webkitGetUserMedia || 
                navigator.mozGetUserMedia ||
                navigator.msgGetUserMedia);
                if(navigator.getUserMedia){
                    navigator.getUserMedia({video: true},loadCam, loadFail);
                }
                setInterval(function(){
                    console.log('calling video');
                     viewVideo(video, context);
                 }, 70);
            });
        </script>
    </body>
</html>